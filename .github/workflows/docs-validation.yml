name: Documentation Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate-docs:
    name: Validate PAI Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: |
          # No dependencies needed for test runner
          echo "Test runner is self-contained"

      - name: Setup PAI documentation paths
        run: |
          echo "ğŸ“ Setting up PAI documentation for CI validation..."
          mkdir -p "$HOME/.claude"
          mkdir -p "$HOME/.claude/scripts"
          mkdir -p "$HOME/.claude/tests"

          # Create symlinks from repo to home directory (CI-friendly approach)
          ln -s "$GITHUB_WORKSPACE/docs/PAI_CHANGELOG.md" "$HOME/.claude/PAI_CHANGELOG.md" 2>/dev/null || cp "$GITHUB_WORKSPACE/docs/PAI_CHANGELOG.md" "$HOME/.claude/PAI_CHANGELOG.md"
          ln -s "$GITHUB_WORKSPACE/docs/PAI_OPERATIONS_LOG.md" "$HOME/.claude/PAI_OPERATIONS_LOG.md" 2>/dev/null || cp "$GITHUB_WORKSPACE/docs/PAI_OPERATIONS_LOG.md" "$HOME/.claude/PAI_OPERATIONS_LOG.md"
          ln -s "$GITHUB_WORKSPACE/docs/PAI_DECISION_LOG.md" "$HOME/.claude/PAI_DECISION_LOG.md" 2>/dev/null || cp "$GITHUB_WORKSPACE/docs/PAI_DECISION_LOG.md" "$HOME/.claude/PAI_DECISION_LOG.md"

          # Copy scripts and tests
          cp -r "$GITHUB_WORKSPACE/scripts/"* "$HOME/.claude/scripts/" 2>/dev/null || true
          cp -r "$GITHUB_WORKSPACE/tests/"* "$HOME/.claude/tests/" 2>/dev/null || true

          echo "âœ… PAI documentation paths configured"

      - name: Validate CHANGELOG format
        run: |
          echo "ğŸ” Validating PAI_CHANGELOG.md format..."

          CHANGELOG_PATH="$HOME/.claude/PAI_CHANGELOG.md"

          # Check for required sections
          if ! grep -q "## \[Unreleased\]" "$CHANGELOG_PATH"; then
            echo "âŒ Missing [Unreleased] section"
            exit 1
          fi

          if ! grep -q "### Added" "$CHANGELOG_PATH"; then
            echo "âŒ Missing ### Added section"
            exit 1
          fi

          # Check for placeholder text
          if grep -q "TODO\|PLACEHOLDER\|FIXME" "$CHANGELOG_PATH"; then
            echo "âŒ Contains placeholder text (TODO/PLACEHOLDER/FIXME)"
            exit 1
          fi

          echo "âœ… CHANGELOG format valid"

      - name: Validate OPERATIONS_LOG format
        run: |
          echo "ğŸ” Validating PAI_OPERATIONS_LOG.md format..."

          OPERATIONS_PATH="$HOME/.claude/PAI_OPERATIONS_LOG.md"

          # Check for required structure
          if ! grep -qE "^## \[[0-9]{4}-[0-9]{2}-[0-9]{2}\]" "$OPERATIONS_PATH"; then
            echo "âŒ Missing date header format ## [YYYY-MM-DD]"
            exit 1
          fi

          if ! grep -q "\*\*Type\*\*:" "$OPERATIONS_PATH"; then
            echo "âŒ Missing **Type**: field"
            exit 1
          fi

          if ! grep -q "\*\*Severity\*\*:" "$OPERATIONS_PATH"; then
            echo "âŒ Missing **Severity**: field"
            exit 1
          fi

          echo "âœ… OPERATIONS_LOG format valid"

      - name: Validate DECISION_LOG (ADR) format
        run: |
          echo "ğŸ” Validating PAI_DECISION_LOG.md format..."

          DECISION_PATH="$HOME/.claude/PAI_DECISION_LOG.md"

          # Check for ADR format
          if ! grep -qE "^# ADR-[0-9]+:" "$DECISION_PATH"; then
            echo "âŒ Missing ADR number format # ADR-XXX:"
            exit 1
          fi

          if ! grep -q "\*\*Status\*\*:" "$DECISION_PATH"; then
            echo "âŒ Missing **Status**: field"
            exit 1
          fi

          if ! grep -q "## Context" "$DECISION_PATH"; then
            echo "âŒ Missing ## Context section"
            exit 1
          fi

          if ! grep -q "## Decision" "$DECISION_PATH"; then
            echo "âŒ Missing ## Decision section"
            exit 1
          fi

          if ! grep -q "## Consequences" "$DECISION_PATH"; then
            echo "âŒ Missing ## Consequences section"
            exit 1
          fi

          # Check ADR sequential numbering
          ADR_NUMBERS=$(grep -oE "# ADR-([0-9]+):" "$DECISION_PATH" | grep -oE "[0-9]+" | sort -n)
          EXPECTED=1
          for NUM in $ADR_NUMBERS; do
            if [ $NUM -ne $EXPECTED ]; then
              echo "âŒ ADR numbers not sequential (expected $EXPECTED, got $NUM)"
              exit 1
            fi
            EXPECTED=$((EXPECTED + 1))
          done

          echo "âœ… DECISION_LOG format valid"

      - name: Run comprehensive test suite
        run: |
          echo "ğŸ§ª Running comprehensive test suite..."
          cd "$HOME/.claude/tests"
          bun test ./run-docs-tests.ts
          echo "âœ… All tests passed"

      - name: Check helper scripts performance
        run: |
          echo "â±ï¸ Checking helper scripts performance..."

          SCRIPTS=(
            "$HOME/.claude/scripts/add-pai-changelog.sh"
            "$HOME/.claude/scripts/add-pai-operation.sh"
            "$HOME/.claude/scripts/add-pai-decision.sh"
          )

          for SCRIPT in "${SCRIPTS[@]}"; do
            if [ ! -f "$SCRIPT" ]; then
              echo "âŒ Script not found: $SCRIPT"
              exit 1
            fi

            # Check script is executable
            if [ ! -x "$SCRIPT" ]; then
              echo "âš ï¸ Script not executable: $SCRIPT"
              chmod +x "$SCRIPT"
            fi

            echo "âœ“ $(basename $SCRIPT) exists and is executable"
          done

          echo "âœ… Helper scripts validated"

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… PAI DOCUMENTATION VALIDATION PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ Validated:"
          echo "  âœ“ PAI_CHANGELOG.md format (Keep a Changelog)"
          echo "  âœ“ PAI_OPERATIONS_LOG.md structure"
          echo "  âœ“ PAI_DECISION_LOG.md ADR format"
          echo "  âœ“ Helper scripts existence and permissions"
          echo "  âœ“ Comprehensive test suite (24 automated tests)"
          echo ""
          echo "ğŸ¯ Documentation system is healthy!"
          echo ""

      - name: Failure summary
        if: failure()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ PAI DOCUMENTATION VALIDATION FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Please check the logs above for specific failures."
          echo ""
          echo "ğŸ“š Documentation:"
          echo "  - See ~/.claude/PAI_CHANGELOG.md for expected format"
          echo "  - See ~/.claude/PAI_OPERATIONS_LOG.md for expected format"
          echo "  - See ~/.claude/PAI_DECISION_LOG.md for ADR template"
          echo ""
